<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>Tetris Game</title>
    
<link href='https://fonts.googleapis.com/css?family=Fira+Sans' rel='stylesheet' type='text/css'>
    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script> 
<script type="text/javascript" src="mturk.js"></script>
    
<script>
   
    var board =
   [[0,0,0,1,0,0],
   [0,0,0,0,1,1],
   [1,1,1,0,0,0],
   [0,0,0,0,0,0],
   [0,0,0,0,0,0],
   [0,0,0,0,0,0],
   [0,0,0,0,0,0]];
    
    var copyboard=[];
    var secPast = 0;
    
    var blockSize = 50;
    var boardHeight = board.length;
    var boardWidth= board[0].length;

    var playerX = 0; //default x position of the player block
    var playerY = board.length-1; //default y position of the player block
    var gameOver = false;
    var reward =0;
    var theInterval;
    var is_active = true;
    var mykey = "friedchicken";
    var crowdX = 2;
    var startTime;
    var lastKeyPress;
    var curTime;
    
    function updateBoard() {
       
        //make data array, sending game board info, player position, game status
        var data_array=[];
        for (y = 0; y < board.length; y++) {
            data_array.push(board[y]);
        }
        data_array.push(playerX);
        data_array.push(gameOver);
        data_array.push(is_active);
        var d = JSON.stringify(data_array);
        
    
        $.ajax({
            
            url: "https://codingthecrowd.com/counter.php?",
            
            dataType: "jsonp",  

            data: {
                 key: mykey,
                 data: d,
                 format: "json"

            },

            success: function( response ) {
                
                var num_peeps = response["count"];
            
                 //synch up the board
                    board=[];
                    var r = JSON.parse(response["results"][0]["data"]);
                    for (j=0; j < r.length-3; j++){
                        board.push(r[j]);
                    }
                  
                //moving the enemy down every second.
                    curTime = new Date().getTime();
                    curTime = curTime/1000;
        
                if (Math.floor(curTime - startTime)>secPast) {
              
                    //copying the  array
                    copyboard = [];
                    for (y = 0; y < board.length; y++) {
                        copyboard.push(board[y]);   
                    }

                    board=[];
                    board.push(copyboard[copyboard.length-1]);
                    //copy the rest of the board
                    for (y = 1; y < copyboard.length; y++) {
                           board.push(copyboard[y-1]);
                    }
                
                    moveEnemy();
                    secPast = secPast + 1;
                    updateReward();

                    }
                            
                //move the collective by taking the average
                var total = 0;
                var count = 0;
                for (i=0; i<num_peeps; i++) {
                    r = JSON.parse(response["results"][i]["data"]); //turn everything back to object.
                    
                    //get the position
                    var p = r[r.length-3]; 
                    //total = total + p;
                    var a = r[r.length-1]; //active status.
                    if (a==true) {
                    
                        total = total + p;
                        count=count+1;
                    }
                    
                    //checking if game is over.
                    var g = r[r.length-2];
                    if (g==true) {
                        
                        gameOver = true;
                        endGame();
                    }
                    
                }
                if (count > 0) {
                    crowdX = Math.ceil(total/count);
                }
            
                
                $(".crowdBlock").css("left", crowdX*blockSize + "px");
                
           
            }
    });
    
    
    }
    
    function endGame() {
        
          alert("Game Over!");
          $("#mturk_form").append("<input id='rewardAmt' type='hidden' value='" + $(".rewardvalue").text() + "' name='rewardAmt'>");
          
          //calculate # of seconds players played.
          var numSec = Math.round(reward*1000);
          
          $("#mturk_form").append("<input id='numSec' type='hidden' value='" + numSec + "' name='numSec'>");
          
          $("#mturk_form").submit();
          clearInterval(theInterval);
    }
    
    
    function checkStatus() {
      
      if (board[playerY][crowdX]==1) {
          
          gameOver=true;
          endGame();
   
      }
        
    }
    
    function updateReward() {
        if (!gameOver) {
            reward = reward + 0.001;  //gets 1/10 of a cent for each second
           
            $(".rewardvalue").html(reward.toFixed(3));
        }
         
    }
    
    
    
    function moveEnemy(){
        
         //toggle the class to change colors.
               for (y = 0; y < board.length; y++) {
                  for (x = 0; x < board[0].length; x++) {

                        if(board[y][x]==1) {
                            $("#grid_" + y + "_" + x).toggleClass("enemyBlock", true);
                        } else {
                            $("#grid_" + y + "_" + x).toggleClass("enemyBlock", false);
                        }
                  }
              }
        
    }
    
    

    
    function startGame() {
        
    
        startTime = new Date().getTime(); //in ms
        startTime = startTime/1000;
        
        //event handler for moving the player block. player block can 'wrap' around the board.
        
        
        $(document).keydown(function(e) {
            
        
            if(e.keyCode==37) { //left arrow
                is_active = true;
                lastKeyPress = new Date().getTime();
                
                if (playerX > 0) {
                   playerX -= 1;    
                } else {
                    playerX = board[0].length-1;
                    
                }
                
                checkStatus();
        } else if(e.keyCode == 39) { //right arrow
            is_active = true;
            lastKeyPress = new Date().getTime();
            
            if (playerX < board[0].length-1) {
                playerX += 1;
            }else {
                playerX =0;
            }
            checkStatus();
        }
            $(".playerBlock").css("left", playerX*blockSize + "px");
      });
        
        
        theInterval = setInterval(function() {
            
            
            curTime = new Date().getTime();
            curTime = curTime/1000;
            lastKeyPress = lastKeyPress/1000;
            
            if (Math.floor(curTime - lastKeyPress)>2) {
                is_active=false;
            }
            
            updateBoard(); 
            checkStatus();
          
         
      }, 200); 
    }
    
    $(document).ready(function() {
 
        var gameboard = $("<div id='gameboard' style='width:" + boardWidth*blockSize + "px; height:" + boardHeight*blockSize +"px;'></div>");  
        $("#wrapper").append(gameboard);
        
        
        //add grid cells on the board
        var toppx = 0;
        for (y = 0; y < board.length; y++) {
            var leftpx =0;
            for (x = 0; x < board[0].length; x++) { 
                var cell = $("<div id='grid_" + y + "_" + x + "' class='cell' style='width:" + blockSize + "px; height:" + blockSize +"px; left:"+ leftpx + "px; top:" + toppx + "px;'> </div>");
                $(gameboard).append(cell);
                
                //determine whether the cell is an enemy block
                if(board[y][x]==1) {
                    $("#grid_" + y + "_" + x).toggleClass("enemyBlock", true);
                }
                leftpx += blockSize;
            }
            toppx += blockSize;
        }
        
        //create the rocket ship block (the player)
        var player = $("<div class='playerBlock' style='width:" + blockSize + "px; height:" + blockSize +"px; left:0px; top:" + playerY*blockSize + "px;'> </div>");
        $(gameboard).append(player);
        
        //create the collective player
        var crowd = $("<div class='crowdBlock' style='width:" + blockSize + "px; height:" + blockSize +"px; left:0px; top:" + playerY*blockSize + "px;'> </div>");
        $(gameboard).append(crowd);
        
    
    })
</script>
    
<style>
    
#wrapper {
    background-color: whitesmoke;
    height: 100%;
    width: 100%;
        
}    
#gameboard {
  background-color: black;
  position: relative;
  margin-top: 20px;
  margin-left: auto;
  margin-right: auto;
  width: 80%;
  border: 2px dimgray solid;
  
}
.cell {
  background-color: lightgray;
  position: absolute;
}
    
.enemyBlock {
  background-color: dodgerblue;

  position: absolute;
}
    
.playerBlock {
  background-color: darkseagreen;

  position: absolute;
}
    
.crowdBlock {
  background-image: url(aliens.gif);
  position: absolute;
}
    
h1 {

    text-align: center;
    padding-top: 20px;
    color: lightslategray;
    font-family: "Droid Sans", sans-serif;
        
}
    
h2 {

    text-align: center;
    color: lightslategray;
    font-family: "Droid Sans", sans-serif;
    
}
    

    
#instructions {
    
    text-align: left;
    color: darkslategray;
    font-family: "Fira Sans", sans-serif;   
    font-size: 17px;
    line-height: 115%;
    
    margin-left: auto;
    margin-right: auto;
    width: 40%;
    padding: 10px;
    
    border: 2px darkseagreen solid;
    
}
    
#startBtn {
        
color: red;
font-size: 20px;
        
}
    
    
</style>
    
</head>
<body>
    
    <div id="wrapper">
        <div id="header">
            
        
            <h1>SPACE WARS</h1>
            <div id="instructions"><center>INSTRUCTIONS</center><br>Use the left or right mouse key to move your ship (green block) to avoid the enemy ship (blue blocks).  The alien ship (the 'collective') will move based on an average of the moves of active players.  You will be rewarded with $0.001 for every second the alien collective ship does not hit a blue block.  
            <br><br>
            <center>
            <button id="startBtn" type="button" onClick="startGame()">Start Game</button>
            </center>
            </div>
        
        </div>
        
        <div id="reward">
            <h2>Reward: $<span class="rewardvalue">0.00</span></h2>
        
        </div>
        
       

     <form id="mturk_form" name="mturk_form">
      
         
     </form>
    </div>

    
</body>
</html>
